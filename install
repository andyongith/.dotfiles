#!/usr/bin/bash

function install_deps() {
  sudo pacman -Sy
  sudo pacman -S --needed --noconfirm git nerd-fonts noto-fonts \
    noto-fonts-emoji noto-fonts-cjk noto-fonts-extra
  
  if [ ! -d $HOME/.config ]; then
    mkdir $HOME/.config
  fi
}

function config_kitty() {
  cd $HOME
  mkdir -p .config/kitty
  rm -rf .config/kitty/kitty.conf
  ln -sf ../../.dotfiles/.config/kitty/kitty.conf .config/kitty/kitty.conf
}

function config_tmux() {
  cd $HOME
  ln -sf .dotfiles/.tmux.conf
}

function config_vim() {
  cd $HOME
  ln -sf .dotfiles/.vimrc
}

function config_ranger() {
  cd $HOME
  mkdir -p .config/ranger
  rm -rf .config/ranger/rc.conf
  ln -sf ../../.dotfiles/.config/ranger/rc.conf .config/ranger/rc.conf
}

function install_oh_my_bash() {
  bash -c "$(curl -fsSL https://raw.githubusercontent.com/ohmybash/oh-my-bash/master/tools/install.sh)" --unattended
  sed -i "$(grep -n OSH_THEME= $HOME/.bashrc | cut -d: -f1)s/.*/OSH_THEME=powerline-multiline/" $HOME/.bashrc
}

function install_yay() {
  cd $HOME
  if which yay; then
    echo "yay is already installed"
  else
    git clone https://aur.archlinux.org/yay.git yay-git
    cd yay-git
    makepkg -si --noconfirm
  fi
}

#function theme_grub() {
#  #code to add a grub theme
#}


### Menu
actions=(
  install_deps config_kitty config_tmux config_vim config_ranger
  install_oh_my_bash install_yay theme_grub
)
selected_actions=(
  install_deps config_kitty config_tmux config_vim config_ranger
  install_oh_my_bash
)

function select_from_menu()
{
  local prompt="--Select the configs you wanna install--"
  local options=(
    "install dependencies" "kitty" "tmux" "vim" "ranger"
    "install oh_my_bash" "install yay" "grub theme" "INSTALL"
  )
  local count=${#options[@]}
  local cursor=$(($count-1))
  local esc=$(echo -en "\e")
  
  echo $prompt
  while true
  do
    ## printing menu
    local index=0
    for opt in "${options[@]}"
    do
      if [[ -z "${actions[$index]}" ]]
      then
        echo -en "  \e[1;33m"
      elif $(echo ${selected_actions[@]} | grep -q "${actions[$index]}")
      then
        echo -en " \e[0;32m+\e[0m"
      else
        echo -en " \e[0;31m-\e[0m"
      fi
      if [[ $cursor == $index ]]
      then
        echo -e " \e[7m$opt\e[0m <  "
      else
        echo -e " $opt\e[0m  "
      fi
      ((index+=1))
    done
    ## keyboard event handler
    local key0
    local key
    read -s -n1 key0
    if [[ $key0 == "" ]]
    then
      if [[ -z "${actions[$cursor]}" ]]
      then
        break
      elif $(echo ${selected_actions[@]} | grep -q "${actions[$cursor]}")
      then
        selected_actions=(${selected_actions[@]/${actions[$cursor]}})
      else
        selected_actions=(${selected_actions[@]} ${actions[$cursor]})
      fi
    elif [[ $key0 == $esc ]]
    then
      read -s -n2 key
      if [[ $key == [A ]]
      then
        ((cursor-=1))
        [[ $cursor -lt 0 ]] && ((cursor = $count - 1))
      elif [[ $key == [B ]]
      then
        ((cursor+=1))
        [[ $cursor -ge $count ]] && cursor=0
      fi
    fi
    echo -en "\e[${count}A"
  done
}

function install_selected() {
  for action in ${selected_actions[@]}
  do
    ${action}
  done
}

select_from_menu
install_selected

echo -e "\e[1mnote:You need to reload your terminal\e[0m"
